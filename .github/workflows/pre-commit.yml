name: Pre-commit Checks

on:
    pull_request:
        types: [opened, synchronize, reopened]
    push:
        branches:
            - main
            - master
            - develop

jobs:
    pre-commit:
        name: Run Pre-commit Hooks
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for better diffs

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'
                  cache: 'pip'

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install Node.js dependencies
              run: npm ci

            - name: Install pre-commit
              run: |
                  pip install pre-commit
                  pre-commit --version

            - name: Cache pre-commit hooks
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pre-commit
                  key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
                  restore-keys: |
                      pre-commit-${{ runner.os }}-

            - name: Run pre-commit on all files
              if: github.event_name == 'push'
              run: pre-commit run --all-files --show-diff-on-failure --color=always

            - name: Run pre-commit on changed files
              if: github.event_name == 'pull_request'
              run: |
                  # Get list of changed files
                  git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

                  # Run pre-commit only on changed files if any exist
                  if [ -s changed_files.txt ]; then
                    pre-commit run --files $(cat changed_files.txt | tr '\n' ' ') --show-diff-on-failure --color=always
                  else
                    echo "No files changed"
                  fi

            - name: Comment PR with results
              if: failure() && github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: '‚ùå Pre-commit checks failed. Please run `pre-commit run --all-files` locally and commit the fixes.'
                      })
