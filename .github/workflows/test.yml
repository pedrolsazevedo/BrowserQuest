name: Tests

on:
    pull_request:
        types: [opened, synchronize, reopened]
    push:
        branches:
            - main
            - master
            - develop

jobs:
    test:
        name: Run Tests
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [20.x, 22.x]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run tests
              run: npm test

            - name: Run security audit
              run: npm audit --audit-level=moderate

            - name: Check code formatting
              run: npm run format:check

    server-startup:
        name: Test Server Startup
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Start server in background
              run: |
                  node server/js/main.js > server.log 2>&1 &
                  SERVER_PID=$!
                  echo $SERVER_PID > server.pid

            - name: Wait for server to start
              run: |
                  timeout 30 bash -c 'until curl -s http://localhost:8000/status > /dev/null; do sleep 1; done'

            - name: Test server status endpoint
              run: |
                  RESPONSE=$(curl -s http://localhost:8000/status)
                  echo "Server status: $RESPONSE"
                  if [[ $RESPONSE != "["* ]]; then
                    echo "Invalid status response"
                    exit 1
                  fi

            - name: Stop server
              if: always()
              run: |
                  if [ -f server.pid ]; then
                    kill $(cat server.pid) || true
                  fi

            - name: Show server logs on failure
              if: failure()
              run: cat server.log
